name: Checkout & Archive Git repository
description: Clone at a specific commit and create a tar archive with commit timestamp
inputs:
  repo:
    description: "Repository URL"
    required: true
  ref:
    description: "Commit SHA or branch to checkout"
    required: true
  dir:
    description: "Directory to emit the repo and archive"
    required: true
runs:
  using: "composite"
  steps:
    - name: Ensure target directory does not exist
      shell: bash 
      run: |
        ! [[ -d "${{ inputs.dir }}" ]] || {
          echo "Directory '${{ inputs.dir }}' already exists. Aborting."
          exit 1
        }

    - name: Checkout repository and create archive
      shell: bash
      run: |
        mkdir -p "${{ inputs.dir }}"

        git clone --no-checkout --depth 1 "${{ inputs.repo }}" "${{ inputs.dir }}"
        cd "${{ inputs.dir }}"

        git fetch --depth=1 origin "${{ inputs.ref }}"

        COMMIT_SHA=$(git rev-parse FETCH_HEAD)

        git checkout "$COMMIT_SHA"

        COMMIT_ETSTAMP=$(git log -1 --format=%ct "$COMMIT_SHA")

        git archive --prefix="${{ inputs.dir }}" --format=tar "$COMMIT_SHA" \
          | tar --mtime="@${COMMIT_ETSTAMP}" -cf ${{ inputs.dir }}.tar
